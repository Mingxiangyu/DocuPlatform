# DocuVault 知识付费平台技术实现任务

## 任务描述
基于项目需求文档 `/prd/知识付费网站PRD.md` 和现有高保真原型设计，将DocuVault知识付费平台从静态HTML原型转换为完整的技术实现。采用Vue 3 + Node.js微服务架构，实现用户认证、内容管理、支付系统、笔记功能等核心业务功能。

**项目背景**: DocuVault是一个现代化的知识付费平台，已完成33个页面的高保真设计，需要转换为可生产部署的技术实现。

**技术目标**: 
- 将现有HTML原型转换为Vue 3组件化架构
- 实现完整的后端API服务
- 建立用户认证和权限管理系统
- 集成支付功能和订单管理
- 实现文章划线笔记系统
- 建立后台内容管理系统

## 验收标准
- [ ] 完整的前端Vue 3应用，支持所有33个页面功能
- [ ] 后端Node.js微服务架构，提供完整API支持
- [ ] 用户认证系统（邮箱登录、微信OAuth、权限管理）
- [ ] 支付系统集成（微信支付、支付宝、订单管理）
- [ ] 文章管理系统（Markdown编辑、文件上传、搜索功能）
- [ ] 笔记系统（文本高亮、笔记编辑、数据同步）
- [ ] 后台管理系统（内容管理、用户管理、数据统计）
- [ ] 响应式设计，完美适配移动端和桌面端
- [ ] 生产环境部署，支持实际用户访问
- [ ] 基础性能优化和安全措施

## 任务分解

### 阶段1：基础架构搭建（2周）
- [ ] 步骤1.1：创建Vue 3 + Vite前端项目，配置TypeScript、ESLint、Prettier
- [ ] 步骤1.2：设置Tailwind CSS设计系统，实现紫色主题配色方案
- [ ] 步骤1.3：配置Vue Router和Pinia状态管理
- [ ] 步骤1.4：创建Node.js + Express后端项目，配置微服务架构
- [ ] 步骤1.5：设置PostgreSQL数据库和Prisma ORM
- [ ] 步骤1.6：配置Redis缓存服务
- [ ] 步骤1.7：实现基础中间件（认证、日志、错误处理）
- [ ] 步骤1.8：配置Docker Compose开发环境

### 阶段2：用户认证系统（1.5周）
- [ ] 步骤2.1：实现前端登录/注册表单组件
- [ ] 步骤2.2：开发扫码登录组件和微信OAuth集成
- [ ] 步骤2.3：创建用户状态管理（Pinia store）
- [ ] 步骤2.4：实现路由守卫和权限控制
- [ ] 步骤2.5：开发后端JWT认证服务
- [ ] 步骤2.6：实现密码加密和验证机制
- [ ] 步骤2.7：建立会话管理和刷新令牌机制
- [ ] 步骤2.8：实施安全措施（CSRF防护、限流中间件）

### 阶段3：内容管理系统（2周）
- [ ] 步骤3.1：开发文章列表组件（网格/列表视图、筛选排序）
- [ ] 步骤3.2：实现文章详情页组件和Markdown渲染器
- [ ] 步骤3.3：创建响应式设计，适配移动端和桌面端
- [ ] 步骤3.4：开发后台Markdown编辑器（实时预览、工具栏）
- [ ] 步骤3.5：实现文件上传系统（封面图片、附件管理）
- [ ] 步骤3.6：建立内容审核工作流和批量操作功能
- [ ] 步骤3.7：实现全文搜索功能（PostgreSQL全文搜索）
- [ ] 步骤3.8：开发搜索结果高亮和搜索建议功能

### 阶段4：支付系统集成（1.5周）
- [ ] 步骤4.1：开发支付弹窗组件和二维码展示
- [ ] 步骤4.2：实现支付状态轮询和结果处理
- [ ] 步骤4.3：集成微信支付API和支付宝API
- [ ] 步骤4.4：建立订单管理系统和支付记录
- [ ] 步骤4.5：实现Webhook处理和支付回调
- [ ] 步骤4.6：开发财务统计和收入分析功能
- [ ] 步骤4.7：实施支付安全措施（防重复、异常处理）
- [ ] 步骤4.8：建立数据一致性保证机制

### 阶段5：笔记系统实现（2周）
- [ ] 步骤5.1：实现文本选择和高亮功能（Range API）
- [ ] 步骤5.2：开发笔记编辑器和管理界面
- [ ] 步骤5.3：创建笔记列表和分组显示功能
- [ ] 步骤5.4：实现笔记数据同步机制
- [ ] 步骤5.5：建立笔记数据模型和位置信息存储
- [ ] 步骤5.6：开发笔记搜索和筛选功能
- [ ] 步骤5.7：实现笔记数据导出功能
- [ ] 步骤5.8：优化用户体验（离线支持、自动保存）

### 阶段6：后台管理系统（1.5周）
- [ ] 步骤6.1：开发管理员认证和权限控制系统
- [ ] 步骤6.2：实现内容管理界面（文章、合集、分类）
- [ ] 步骤6.3：创建用户管理功能（角色分配、权限管理）
- [ ] 步骤6.4：建立数据统计面板（用户、订单、收入分析）
- [ ] 步骤6.5：实现批量操作和数据导出功能
- [ ] 步骤6.6：开发系统设置和配置管理
- [ ] 步骤6.7：建立操作日志和审计功能

### 阶段7：性能优化和部署（2周）
- [ ] 步骤7.1：实施前端代码分割和懒加载
- [ ] 步骤7.2：优化图片处理和文件压缩
- [ ] 步骤7.3：配置缓存策略（Redis、浏览器缓存）
- [ ] 步骤7.4：优化数据库查询和索引
- [ ] 步骤7.5：设置生产环境部署（单服务器方案）
- [ ] 步骤7.6：配置域名、SSL证书和Nginx反向代理
- [ ] 步骤7.7：建立基础监控和日志系统
- [ ] 步骤7.8：实施数据备份和恢复策略

### 阶段8：测试和质量保证（1周）
- [ ] 步骤8.1：进行核心功能手动测试验证
- [ ] 步骤8.2：验证移动端响应式设计和兼容性
- [ ] 步骤8.3：实施基础安全检查和漏洞扫描
- [ ] 步骤8.4：进行性能测试和优化调整
- [ ] 步骤8.5：用户验收测试和反馈收集
- [ ] 步骤8.6：修复发现的问题和优化用户体验

## 进度追踪
| 完成百分比 | 状态更新 | 时间 |
|------------|---------|------|
| 0% | 任务创建，开始技术实现 | 2024-12-10 |

## 问题与风险
- [ ] 问题1：微信支付API集成复杂性 - [需要申请商户号和开发者账号]
- [ ] 风险1：数据库性能瓶颈 - [实施查询优化和索引策略]
- [ ] 风险2：前端组件化迁移工作量 - [采用渐进式迁移策略]
- [ ] 风险3：支付安全性要求 - [严格遵循支付平台安全规范]

## 技术架构概览

### 前端技术栈
- **框架**: Vue 3 + Composition API
- **构建工具**: Vite
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **UI框架**: Tailwind CSS
- **类型检查**: TypeScript

### 后端技术栈
- **运行时**: Node.js
- **框架**: Express.js
- **数据库**: PostgreSQL + Prisma ORM
- **缓存**: Redis
- **认证**: JWT + OAuth 2.0
- **支付**: 微信支付 + 支付宝

### 部署架构
- **生产环境**: 单服务器部署（云服务器）
- **数据库**: 云数据库服务
- **文件存储**: 云对象存储
- **反向代理**: Nginx
- **监控**: 基础服务器监控

## 详细技术规范

### 前端组件化架构设计
```
src/
├── components/
│   ├── atoms/                    # 基础组件
│   │   ├── Button.vue           # 按钮组件（主要、次要、危险等变体）
│   │   ├── Input.vue            # 输入框组件（文本、密码、搜索等）
│   │   ├── Icon.vue             # 图标组件（Font Awesome集成）
│   │   ├── Badge.vue            # 标签组件（状态、分类标签）
│   │   └── Avatar.vue           # 头像组件（用户头像、占位符）
│   ├── molecules/               # 组合组件
│   │   ├── SearchBox.vue        # 搜索框（输入框+按钮+建议）
│   │   ├── ArticleCard.vue      # 文章卡片（标题、摘要、价格、操作）
│   │   ├── PaymentModal.vue     # 支付弹窗（二维码、倒计时、状态）
│   │   ├── NoteEditor.vue       # 笔记编辑器（高亮、编辑、保存）
│   │   └── FileUpload.vue       # 文件上传（拖拽、进度、预览）
│   ├── organisms/               # 页面组件
│   │   ├── Header.vue           # 页面头部（导航、用户菜单、搜索）
│   │   ├── Sidebar.vue          # 侧边栏（导航菜单、用户信息）
│   │   ├── ArticleList.vue      # 文章列表（筛选、排序、分页）
│   │   ├── MarkdownEditor.vue   # Markdown编辑器（工具栏、预览）
│   │   └── AdminPanel.vue       # 管理面板（统计、快捷操作）
│   └── templates/               # 页面模板
│       ├── DefaultLayout.vue    # 默认布局（头部+内容+底部）
│       ├── AuthLayout.vue       # 认证布局（登录、注册页面）
│       └── AdminLayout.vue      # 管理后台布局（侧边栏+内容）
```

### 状态管理架构设计
```typescript
// stores/auth.ts - 用户认证状态
interface AuthState {
  user: User | null
  token: string | null
  isAuthenticated: boolean
  permissions: string[]
}

// stores/articles.ts - 文章内容状态
interface ArticlesState {
  articles: Article[]
  currentArticle: Article | null
  categories: Category[]
  searchResults: Article[]
  loading: boolean
}

// stores/notes.ts - 笔记系统状态
interface NotesState {
  notes: Note[]
  highlights: Highlight[]
  currentNote: Note | null
  syncStatus: 'idle' | 'syncing' | 'error'
}

// stores/payment.ts - 支付系统状态
interface PaymentState {
  orders: Order[]
  currentOrder: Order | null
  paymentMethods: PaymentMethod[]
  paymentStatus: 'idle' | 'pending' | 'success' | 'failed'
}
```

### API接口详细设计
```typescript
// 用户认证接口
interface AuthAPI {
  // POST /api/auth/login
  login(credentials: LoginCredentials): Promise<AuthResponse>
  // POST /api/auth/register
  register(userData: RegisterData): Promise<AuthResponse>
  // POST /api/auth/logout
  logout(): Promise<void>
  // GET /api/auth/profile
  getProfile(): Promise<User>
  // POST /api/auth/refresh
  refreshToken(): Promise<TokenResponse>
  // POST /api/auth/oauth/wechat
  wechatLogin(code: string): Promise<AuthResponse>
}

// 文章管理接口
interface ArticlesAPI {
  // GET /api/articles?page=1&limit=20&category=&search=
  getArticles(params: ArticleQueryParams): Promise<PaginatedResponse<Article>>
  // GET /api/articles/:id
  getArticle(id: string): Promise<Article>
  // POST /api/articles
  createArticle(article: CreateArticleData): Promise<Article>
  // PUT /api/articles/:id
  updateArticle(id: string, article: UpdateArticleData): Promise<Article>
  // DELETE /api/articles/:id
  deleteArticle(id: string): Promise<void>
  // GET /api/articles/:id/content
  getArticleContent(id: string): Promise<ArticleContent>
}

// 笔记系统接口
interface NotesAPI {
  // GET /api/notes?article_id=&type=
  getNotes(params: NoteQueryParams): Promise<Note[]>
  // POST /api/notes
  createNote(note: CreateNoteData): Promise<Note>
  // PUT /api/notes/:id
  updateNote(id: string, note: UpdateNoteData): Promise<Note>
  // DELETE /api/notes/:id
  deleteNote(id: string): Promise<void>
  // POST /api/notes/sync
  syncNotes(notes: Note[]): Promise<SyncResponse>
}

// 支付系统接口
interface PaymentAPI {
  // POST /api/payments/create
  createPayment(data: CreatePaymentData): Promise<PaymentOrder>
  // GET /api/payments/:id/status
  getPaymentStatus(id: string): Promise<PaymentStatus>
  // POST /api/payments/webhook
  handleWebhook(data: WebhookData): Promise<void>
  // GET /api/orders
  getOrders(params: OrderQueryParams): Promise<PaginatedResponse<Order>>
}
```

### 数据库设计详细规范
```sql
-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    nickname VARCHAR(100),
    avatar_url TEXT,
    role user_role DEFAULT 'user',
    wechat_openid VARCHAR(100),
    email_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 文章表
CREATE TABLE articles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL,
    content TEXT NOT NULL,
    excerpt TEXT,
    cover_image_url TEXT,
    author_id UUID REFERENCES users(id),
    category_id UUID REFERENCES categories(id),
    is_paid BOOLEAN DEFAULT false,
    price DECIMAL(10,2),
    status article_status DEFAULT 'draft',
    view_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- 全文搜索索引
    CONSTRAINT articles_search_idx
    CHECK (to_tsvector('chinese', title || ' ' || content) IS NOT NULL)
);

-- 笔记表
CREATE TABLE notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    article_id UUID REFERENCES articles(id),
    highlight_text TEXT,
    note_text TEXT,
    highlight_color VARCHAR(20) DEFAULT 'yellow',
    position_data JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- 复合索引优化查询
    INDEX idx_notes_user_article (user_id, article_id),
    INDEX idx_notes_created (created_at DESC)
);

-- 订单表
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    article_id UUID REFERENCES articles(id),
    collection_id UUID REFERENCES collections(id),
    amount DECIMAL(10,2) NOT NULL,
    status order_status DEFAULT 'pending',
    payment_method VARCHAR(50),
    payment_id VARCHAR(255),
    paid_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),

    -- 防重复购买约束
    UNIQUE(user_id, article_id),
    UNIQUE(user_id, collection_id)
);

-- 合集表
CREATE TABLE collections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL,
    description TEXT,
    cover_image_url TEXT,
    price DECIMAL(10,2) NOT NULL,
    author_id UUID REFERENCES users(id),
    status collection_status DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 合集文章关联表
CREATE TABLE collection_articles (
    collection_id UUID REFERENCES collections(id),
    article_id UUID REFERENCES articles(id),
    sort_order INTEGER DEFAULT 0,
    PRIMARY KEY (collection_id, article_id)
);
```

### 安全策略详细规范
```typescript
// JWT配置
const JWT_CONFIG = {
  accessTokenExpiry: '15m',
  refreshTokenExpiry: '7d',
  algorithm: 'HS256',
  issuer: 'docuvault',
  audience: 'docuvault-users'
}

// 密码策略
const PASSWORD_POLICY = {
  minLength: 8,
  requireUppercase: true,
  requireLowercase: true,
  requireNumbers: true,
  requireSpecialChars: false,
  maxAttempts: 5,
  lockoutDuration: '15m'
}

// API限流策略
const RATE_LIMIT_CONFIG = {
  auth: { windowMs: 15 * 60 * 1000, max: 5 }, // 登录限制
  api: { windowMs: 15 * 60 * 1000, max: 100 }, // API调用限制
  payment: { windowMs: 60 * 1000, max: 3 }, // 支付限制
  upload: { windowMs: 60 * 1000, max: 10 } // 上传限制
}

// 输入验证规则
const VALIDATION_RULES = {
  email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
  password: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/,
  nickname: /^[\u4e00-\u9fa5a-zA-Z0-9_]{2,20}$/,
  articleTitle: { minLength: 5, maxLength: 500 },
  noteText: { maxLength: 2000 }
}
```

### 部署架构详细规范
```yaml
# docker-compose.yml - 开发环境
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
    environment:
      - VITE_API_URL=http://localhost:8000

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/docuvault
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your-secret-key

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=docuvault
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

```nginx
# nginx.conf - 生产环境配置
server {
    listen 80;
    server_name docuvault.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name docuvault.com;

    ssl_certificate /etc/ssl/certs/docuvault.crt;
    ssl_certificate_key /etc/ssl/private/docuvault.key;

    # 前端静态文件
    location / {
        root /var/www/docuvault/dist;
        try_files $uri $uri/ /index.html;

        # 缓存策略
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传限制
    client_max_body_size 50M;
}
```

### 测试策略详细规范
```typescript
// 手动测试清单
interface TestCase {
  module: string
  scenario: string
  steps: string[]
  expected: string
  priority: 'high' | 'medium' | 'low'
}

const TEST_CASES: TestCase[] = [
  {
    module: '用户认证',
    scenario: '邮箱登录流程',
    steps: [
      '1. 访问登录页面',
      '2. 输入有效邮箱和密码',
      '3. 点击登录按钮',
      '4. 验证跳转到首页'
    ],
    expected: '用户成功登录，显示用户信息',
    priority: 'high'
  },
  {
    module: '支付系统',
    scenario: '文章购买流程',
    steps: [
      '1. 浏览付费文章',
      '2. 点击购买按钮',
      '3. 选择支付方式',
      '4. 完成支付',
      '5. 验证文章解锁'
    ],
    expected: '支付成功，文章内容完全可见',
    priority: 'high'
  },
  {
    module: '笔记系统',
    scenario: '文本高亮和笔记',
    steps: [
      '1. 阅读文章页面',
      '2. 选择文本段落',
      '3. 点击高亮按钮',
      '4. 添加笔记内容',
      '5. 保存笔记'
    ],
    expected: '文本高亮显示，笔记保存成功',
    priority: 'high'
  }
]

// 性能测试指标
const PERFORMANCE_TARGETS = {
  pageLoadTime: '< 3s', // 页面加载时间
  apiResponseTime: '< 500ms', // API响应时间
  firstContentfulPaint: '< 1.5s', // 首次内容绘制
  largestContentfulPaint: '< 2.5s', // 最大内容绘制
  cumulativeLayoutShift: '< 0.1', // 累积布局偏移
  firstInputDelay: '< 100ms' // 首次输入延迟
}

// 兼容性测试矩阵
const COMPATIBILITY_MATRIX = {
  browsers: [
    'Chrome 120+',
    'Firefox 120+',
    'Safari 17+',
    'Edge 120+'
  ],
  devices: [
    'iPhone 12/13/14/15',
    'Samsung Galaxy S21/S22/S23',
    'iPad Air/Pro',
    'Desktop 1920x1080',
    'Desktop 1366x768'
  ],
  features: [
    '响应式布局',
    '触摸交互',
    '文件上传',
    '支付功能',
    '文本选择'
  ]
}
```

### 监控和日志规范
```typescript
// 错误监控配置
const ERROR_MONITORING = {
  frontend: {
    tool: 'Sentry',
    config: {
      dsn: 'https://your-sentry-dsn',
      environment: process.env.NODE_ENV,
      tracesSampleRate: 0.1,
      beforeSend: (event) => {
        // 过滤敏感信息
        if (event.user) {
          delete event.user.email
        }
        return event
      }
    }
  },
  backend: {
    tool: 'Winston + Sentry',
    levels: ['error', 'warn', 'info', 'debug'],
    transports: ['console', 'file', 'sentry']
  }
}

// 业务指标监控
const BUSINESS_METRICS = {
  userMetrics: [
    '日活跃用户数 (DAU)',
    '月活跃用户数 (MAU)',
    '用户注册转化率',
    '用户留存率 (1日/7日/30日)'
  ],
  contentMetrics: [
    '文章浏览量',
    '文章完读率',
    '搜索使用率',
    '笔记创建数量'
  ],
  businessMetrics: [
    '付费转化率',
    '客单价 (ARPU)',
    '总收入 (GMV)',
    '退款率'
  ]
}
```

## 实施建议和最佳实践

### 开发流程建议
1. **版本控制策略**: 采用Git Flow工作流，main分支为生产环境，develop分支为开发环境
2. **代码审查**: 所有代码变更必须经过Code Review，确保代码质量和知识共享
3. **持续集成**: 配置GitHub Actions或GitLab CI，自动运行代码检查和构建
4. **文档维护**: 及时更新API文档、组件文档和部署文档

### 性能优化建议
1. **前端优化**: 实施代码分割、图片懒加载、CDN加速
2. **后端优化**: 数据库查询优化、Redis缓存、API响应压缩
3. **数据库优化**: 合理设计索引、定期分析查询性能
4. **监控告警**: 设置关键指标监控，及时发现性能问题

### 安全加固建议
1. **输入验证**: 所有用户输入必须进行严格验证和清理
2. **权限控制**: 实施最小权限原则，定期审查用户权限
3. **数据加密**: 敏感数据传输和存储加密
4. **安全审计**: 定期进行安全漏洞扫描和渗透测试

## 备注
- 严格遵循现有的紫色主题设计系统（#a855f7, #9333ea, #7c3aed）
- 保持与33个高保真页面的设计一致性
- 优先实现核心业务功能，后续迭代优化性能和用户体验
- 采用渐进式开发策略，确保每个阶段都有可演示的功能
- 重点关注数据安全和用户隐私保护
- 本文档作为技术实现的详细指南，开发团队应严格按照规范执行
- 如遇技术难点或需求变更，应及时更新本文档并通知相关人员
